<!doctype html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Corporate Meeting Room Booking</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/cssindex.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="js/EF.js"></script>
    
  </head>
  <body>
    <nav class="navbar">
        <div class="nav-brand">
            üè¢ Meeting Room System
        </div>
        <div class="user-profile" id="userSection">
            <p>üë®üèª‚ÄçüíºUser Name:   </p>
            <span id="userName">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
            <button type="button" onclick="logoutUser()" class="btn-logout">
                ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
            </button>
        </div>
    </nav>

    <script>
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô (Session) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const isLoggedIn = localStorage.getItem('currentUser');
    
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ‡πÉ‡∏´‡πâ‡∏î‡∏µ‡∏î‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    if (!isLoggedIn) {
        window.location.href = 'Login.html';
    }
    </script>

    <div class="container">

    <div class="container">
      <header>
        <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£</h1>
      </header>

      <div class="room-grid" id="roomContainer"></div>
      <hr style="margin: 60px 0" />

      <section class="history-section">
        <h2 class="history-title">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h2>

        <div id="adminControls" style="margin-bottom: 15px; display: none">
          <button
            onclick="clearHistory()"
            class="btn-cancel"
            style="width: auto"
          >
            üóë ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
          </button>
          <button
            onclick="resetAllRooms()"
            class="btn-cancel"
            style="width: auto"
          >
            ‚ôªÔ∏è ‡∏Ñ‡∏∑‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
          </button>
          <button onclick="logoutAdmin()" class="btn-close" style="width: auto">
            ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
          </button>
        </div>

        <div class="table-wrapper">
          <table class="history-table" id="historyTable">
            <thead>
              <tr>
                <th>‡∏´‡πâ‡∏≠‡∏á</th>
                <th>‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</th>
                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </div>

    <div class="modal-overlay" id="bookingModal">
      <div class="modal-box">
        <div class="modal-header">
          <h2 id="modalRoomName">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á...</h2>
          <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</p>
        </div>

        <div class="form-group">
          <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</label>
          <input type="text" id="inputName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏ú‡∏ô‡∏Å IT" />
        </div>

        <label
          style="
            font-weight: 500;
            color: #334155;
            margin-bottom: 8px;
            display: block;
          "
          >‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 14 ‡∏ß‡∏±‡∏ô)</label
        >
        <div class="calendar-wrapper">
          <div class="calendar-header">
            <button class="cal-nav-btn" onclick="changeMonth(-1)">
              &#10094;
            </button>
            <span id="monthYearLabel">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏° 2569</span>
            <button class="cal-nav-btn" onclick="changeMonth(1)">
              &#10095;
            </button>
          </div>
          <div class="calendar-days-header">
            <div>‡∏≠‡∏≤</div>
            <div>‡∏à</div>
            <div>‡∏≠</div>
            <div>‡∏û</div>
            <div>‡∏û‡∏§</div>
            <div>‡∏®</div>
            <div>‡∏™</div>
          </div>
          <div class="calendar-grid" id="calendarGrid"></div>
        </div>
        <input type="hidden" id="selectedDateValue" />

        <div class="form-group">
          <label>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡πÄ‡∏£‡∏¥‡πà‡∏° - ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î)</label>
          <div class="time-range-group">
            <select
              id="startTime"
              class="time-select"
              onchange="updateEndTimeSelect()"
            >
              <option value="" disabled selected>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</option>
            </select>
            <span>‡∏ñ‡∏∂‡∏á</span>
            <select id="endTime" class="time-select">
              <option value="" disabled selected>‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</option>
            </select>
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn-close" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button class="btn-confirm" onclick="confirmBooking()">
            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
          </button>
        </div>
      </div>
    </div>

    <div class="modal-overlay" id="adminModal">
      <div class="modal-box">
        <div class="modal-header">
          <h2>Admin Login</h2>
          <p>‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</p>
        </div>

        <div class="form-group">
          <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
          <input
            type="password"
            id="adminPassword"
            placeholder="Admin Password"
          />
        </div>

        <div class="modal-actions">
          <button class="btn-close" onclick="closeAdminLogin()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button class="btn-confirm" onclick="loginAdmin()">
            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
          </button>
        </div>
      </div>
    </div>

    <script>
      // --- Data ---
      const defaultRooms = [
        {
          id: 1,
          name: "‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 1",
          capacity: 12,
          status: "available",
          user: "",
          date: "",
          time: "",
        },
        {
          id: 2,
          name: "‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 2",
          capacity: 6,
          status: "available",
          user: "",
          date: "",
          time: "",
        },
        {
          id: 3,
          name: "‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 3",
          capacity: 4,
          status: "available",
          user: "",
          date: "",
          time: "",
        },
        {
          id: 4,
          name: "‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 4",
          capacity: 30,
          status: "available",
          user: "",
          date: "",
          time: "",
        },
        {
          id: 5,
          name: "‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 5",
          capacity: 2,
          status: "available",
          user: "",
          date: "",
          time: "",
        },
        {
          id: 6,
          name: "‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 6",
          capacity: 20,
          status: "available",
          user: "",
          date: "",
          time: "",
        },
      ];

      let rooms =
        JSON.parse(localStorage.getItem("meetingRooms")) || defaultRooms;

      // Validate Data Integrity
      if (rooms.length < 6 || !rooms[0].hasOwnProperty("date")) {
        rooms = defaultRooms;
        localStorage.removeItem("meetingRooms");
      }

      let bookingHistory =
        JSON.parse(localStorage.getItem("bookingHistory")) || [];
      let currentBookingRoomId = null;

      // --- Admin Config ---
      const ADMIN_PASSWORD = "123";
      let isAdmin = localStorage.getItem("isAdmin") === "true";

      // --- Calendar State ---
      let currentCalDate = new Date();
      let selectedDateObj = null;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
    

      const maxBookingDate = new Date(today);
      maxBookingDate.setDate(today.getDate() + 14);

      // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏π‡πÑ‡∏î‡πâ (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ)
    const minMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    const maxMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);

      // --- Time Configuration ---
      const startOfficeHour = 8;
      const endOfficeHour = 20;

      function populateStartTimeSelect() {
        const startSelect = document.getElementById("startTime");
        startSelect.innerHTML =
          '<option value="" disabled selected>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</option>';
        for (let h = startOfficeHour; h < endOfficeHour; h++) {
          const timeStr = `${h.toString().padStart(2, "0")}:00`;
          startSelect.innerHTML += `<option value="${timeStr}">${timeStr} ‡∏ô.</option>`;
        }
      }

      function updateEndTimeSelect() {
        const startSelect = document.getElementById("startTime");
        const endSelect = document.getElementById("endTime");
        const selectedStart = startSelect.value;
        endSelect.innerHTML =
          '<option value="" disabled selected>‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</option>';

        if (!selectedStart) return;

        const startHourInt = parseInt(selectedStart.split(":")[0]);
        for (let h = startHourInt + 1; h <= endOfficeHour; h++) {
          const timeStr = `${h.toString().padStart(2, "0")}:00`;
          endSelect.innerHTML += `<option value="${timeStr}">${timeStr} ‡∏ô.</option>`;
        }
      }

      populateStartTimeSelect();

      // --- Render Rooms ---
      function renderRooms() {
        const container = document.getElementById("roomContainer");
        container.innerHTML = "";

        rooms.forEach((room) => {
          const isAvailable = room.status === "available";
          const card = document.createElement("div");
          card.className = `room-card ${room.status}`;

          let displayDate = room.date;
          if (room.date) {
            const d = new Date(room.date);
            displayDate = d.toLocaleDateString("th-TH", {
              day: "numeric",
              month: "short",
              year: "numeric",
            });
          }

          card.innerHTML = `
                <div>
                    <div class="badge">${isAvailable ? "‚óè ‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" : "‚óè ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á"}</div>
                    <h2 style="margin: 0 0 5px 0; font-size: 1.5rem;">${room.name}</h2>
                    <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 20px;">
                        <span style="font-size:1.2rem">üë•</span> ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö: ${room.capacity} ‡∏ó‡πà‡∏≤‡∏ô
                    </p>
                    
                    ${
                      !isAvailable
                        ? `
                        <div class="info-box">
                            <strong>‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á:</strong> ${room.user}<br>
                            <strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${displayDate}<br>
                            <strong>‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${room.time} ‡∏ô.
                        </div>
                    `
                        : ""
                    }
                </div>

                ${
                  isAvailable
                    ? `
                    <button class="btn-book" onclick="openModal(${room.id})">‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ</button>
                `
                    : `
                    <button class="btn-cancel" onclick="cancelBooking(${room.id})">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/‡∏Ñ‡∏∑‡∏ô‡∏´‡πâ‡∏≠‡∏á</button>
                `
                }
            `;
          container.appendChild(card);
        });
        localStorage.setItem("meetingRooms", JSON.stringify(rooms));
      }

      // --- Calendar Logic ---
      function renderCalendar() {
        const year = currentCalDate.getFullYear();
        const month = currentCalDate.getMonth();
        const monthsTH = [
          "‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°",
          "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå",
          "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°",
          "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô",
          "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°",
          "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô",
          "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°",
          "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°",
          "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô",
          "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°",
          "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô",
          "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°",
        ];

        document.getElementById("monthYearLabel").innerText =
          `${monthsTH[month]} ${year + 543}`;

        const grid = document.getElementById("calendarGrid");
        grid.innerHTML = "";

        const firstDayIndex = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDayIndex; i++) {
          const emptyCell = document.createElement("div");
          grid.appendChild(emptyCell);
        }

        for (let i = 1; i <= daysInMonth; i++) {
          const dateEl = document.createElement("div");
          dateEl.innerText = i;
          dateEl.className = "cal-date";

          const thisDate = new Date(year, month, i);
          thisDate.setHours(0, 0, 0, 0);

          if (thisDate.getTime() === today.getTime()) {
            dateEl.classList.add("today");
          }

          if (
            selectedDateObj &&
            thisDate.getTime() === selectedDateObj.getTime()
          ) {
            dateEl.classList.add("selected");
          }

          if (thisDate < today || thisDate > maxBookingDate) {
            dateEl.classList.add("disabled");
          } else {
            dateEl.onclick = () => selectDate(thisDate);
          }

          grid.appendChild(dateEl);
        }
        const prevBtn = document.querySelector(".cal-nav-btn:first-child");
const nextBtn = document.querySelector(".cal-nav-btn:last-child");

prevBtn.disabled =
  currentCalDate.getFullYear() === minMonth.getFullYear() &&
  currentCalDate.getMonth() === minMonth.getMonth();

nextBtn.disabled =
  currentCalDate.getFullYear() === maxMonth.getFullYear() &&
  currentCalDate.getMonth() === maxMonth.getMonth();

prevBtn.style.opacity = prevBtn.disabled ? "0.3" : "1";
nextBtn.style.opacity = nextBtn.disabled ? "0.3" : "1";

      }

      function changeMonth(step) {
  const newDate = new Date(
    currentCalDate.getFullYear(),
    currentCalDate.getMonth() + step,
    1
  );

  // ‚ùå ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô
  if (newDate < minMonth || newDate > maxMonth) {
    return;
  }

  currentCalDate = newDate;
  renderCalendar();
}


      function selectDate(date) {
        selectedDateObj = date;
        const offset = date.getTimezoneOffset() * 60000;
        const localISOTime = new Date(date - offset).toISOString().slice(0, 10);
        document.getElementById("selectedDateValue").value = localISOTime;
        renderCalendar();
      }

      // --- Admin Logic ---
      function openAdminLogin() {
        document.getElementById("adminModal").style.display = "flex";
      }

      function closeAdminLogin() {
        document.getElementById("adminModal").style.display = "none";
      }

      function loginAdmin() {
        const pass = document.getElementById("adminPassword").value;
        if (pass === ADMIN_PASSWORD) {
          isAdmin = true;
          localStorage.setItem("isAdmin", "true");
          closeAdminLogin();
          alert("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
          renderHistory();
        } else {
          alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
        }
      }

      function logoutAdmin() {
        isAdmin = false;
        localStorage.removeItem("isAdmin");
        renderHistory();
      }

      // --- Booking Logic ---
      function openModal(id) {
        const room = rooms.find((r) => r.id === id);
        currentBookingRoomId = id;

        document.getElementById("modalRoomName").innerText = room.name;
        document.getElementById("inputName").value = "";
        document.getElementById("startTime").selectedIndex = 0;

        const endSelect = document.getElementById("endTime");
        endSelect.innerHTML =
          '<option value="" disabled selected>‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</option>';
        document.getElementById("selectedDateValue").value = "";

        selectedDateObj = null;
        currentCalDate = new Date();
        renderCalendar();

        document.getElementById("bookingModal").style.display = "flex";
      }

      function closeModal() {
        document.getElementById("bookingModal").style.display = "none";
        currentBookingRoomId = null;
      }

      function confirmBooking() {
        if (!currentBookingRoomId) return;

        const name = document.getElementById("inputName").value;
        const dateStr = document.getElementById("selectedDateValue").value;
        const start = document.getElementById("startTime").value;
        const end = document.getElementById("endTime").value;

        if (!name || !dateStr || !start || !end) {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (‡∏ä‡∏∑‡πà‡∏≠, ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà, ‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤)");
          return;
        }

        const index = rooms.findIndex((r) => r.id === currentBookingRoomId);
        rooms[index].status = "busy";
        rooms[index].user = name;
        rooms[index].date = dateStr;
        rooms[index].time = `${start} - ${end}`;

        bookingHistory.push({
          roomId: rooms[index].id,
          roomName: rooms[index].name,
          user: name,
          date: dateStr,
          time: `${start} - ${end}`,
          createdAt: new Date().toLocaleString("th-TH"),
        });

        localStorage.setItem("bookingHistory", JSON.stringify(bookingHistory));
        renderRooms();
        renderHistory();
        closeModal();
      }

      function cancelBooking(id) {
        if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ?")) return;

        const index = rooms.findIndex((r) => r.id === id);
        const room = rooms[index];

        // ‡∏•‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
        // ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏Å‡πá‡∏ö History ‡πÑ‡∏ß‡πâ‡πÅ‡∏ï‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏ö‡∏à‡∏≤‡∏Å bookingHistory
        // ‡πÅ‡∏ï‡πà‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏∑‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏â‡∏¢‡πÜ

        room.status = "available";
        room.user = "";
        room.date = "";
        room.time = "";

        localStorage.setItem("meetingRooms", JSON.stringify(rooms));
        renderRooms();
        // ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö history ‡∏î‡πâ‡∏ß‡∏¢ ‡∏Å‡πá‡∏ó‡∏≥‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏õ‡∏Å‡∏ï‡∏¥ History ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏î‡∏π‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
        // renderHistory();
      }

      // --- Admin Actions on History ---

      // ‚ú® 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢‡πÄ‡∏ä‡πá‡∏Ñ Data
      function deleteHistoryByData(roomId, user, date, time) {
        if (!confirm("‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) return;

        bookingHistory = bookingHistory.filter(
          (h) =>
            !(
              h.roomId == roomId &&
              h.user === user &&
              h.date === date &&
              h.time === time
            ),
        );

        localStorage.setItem("bookingHistory", JSON.stringify(bookingHistory));
        renderHistory();
      }

      function clearHistory() {
        if (!confirm("‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) return;
        bookingHistory = [];
        localStorage.setItem("bookingHistory", "[]");
        renderHistory();
      }

      function resetAllRooms() {
        if (!confirm("‡∏Ñ‡∏∑‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á?")) return;
        rooms.forEach((r) => {
          r.status = "available";
          r.user = "";
          r.date = "";
          r.time = "";
        });
        localStorage.setItem("meetingRooms", JSON.stringify(rooms));
        renderRooms();
      }

      // --- Render History ---
      function renderHistory() {
        const tbody = document.querySelector("#historyTable tbody");
        tbody.innerHTML = "";

        if (bookingHistory.length === 0) {
          tbody.innerHTML = `
            <tr>
                <td colspan="5" style="text-align:center; padding:20px; color:#64748b;">
                    ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
                </td>
            </tr>
        `;
          document.getElementById("adminControls").style.display = isAdmin
            ? "block"
            : "none";
          return;
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤ (Reverse)
        const reversedHistory = bookingHistory.slice().reverse();

        reversedHistory.forEach((h) => {
          const d = new Date(h.date);
          const displayDate = d.toLocaleDateString("th-TH", {
            day: "numeric",
            month: "short",
            year: "numeric",
          });

          // ‚ú® 2. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å deleteHistoryByData
          tbody.innerHTML += `
            <tr>
              <td>${h.roomName}</td>
              <td>${h.user}</td>
              <td>${displayDate}</td>
              <td>${h.time} ‡∏ô.</td>
              <td>
                ${h.createdAt}
                ${
                  isAdmin
                    ? `<br><button 
                        onclick="deleteHistoryByData('${h.roomId}', '${h.user}', '${h.date}', '${h.time}')"
                        style="margin-top:5px;font-size:0.8rem;color:#dc2626;border:none;background:none;cursor:pointer;width:auto;">
                        ‡∏•‡∏ö
                      </button>`
                    : ""
                }
              </td>
            </tr>
          `;
        });

        // ‚ú® 4. ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Admin Panel
        document.getElementById("adminControls").style.display = isAdmin
          ? "block"
          : "none";
      }

      // Event Listeners
      document
        .getElementById("bookingModal")
        .addEventListener("click", function (e) {
          if (e.target === this) closeModal();
        });

      // --- User session helpers ---
      function updateUserSection() {
        const userSection = document.getElementById('userSection');
        const userNameSpan = document.getElementById('userName');
        try {
          const current = JSON.parse(localStorage.getItem('currentUser'));
          if (current && current.email) {
            userNameSpan.innerText = current.firstname || current.email;
            userSection.style.display = 'flex';
          } else {
            // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ user ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠
            userSection.style.display = 'none';
            userNameSpan.innerText = '';
          }
        } catch (e) {
          userSection.style.display = 'none';
          userNameSpan.innerText = '';
        }
      }

      // logout handled by js/EF.js (logoutUser)

      // Init
      updateUserSection();
      renderRooms();
      renderHistory();
    </script>
    <button class="admin-fab" onclick="openAdminLogin()" title="Admin">
      üë®üèª‚Äçüíº
    </button>
  </body>
</html>
